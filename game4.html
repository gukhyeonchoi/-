<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, maximum-scale=1, minimum-scale=1">
  <title>메모리 카드 게임</title>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      text-align: center;
      background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
      min-height: 100vh;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      padding: 10px;
      padding-bottom: 60px;
      color: #2d3748;
      position: relative;
      overflow: hidden;
      animation: wave-bg 10s infinite alternate;
      touch-action: manipulation;
    }

    @keyframes wave-bg {
      0% { background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%); }
      100% { background: linear-gradient(135deg, #c2e9fb 0%, #a1c4fd 100%); }
    }

    h1 {
      font-size: 2em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      animation: logo-pulse 2s infinite ease-in-out;
      margin: 10px 0;
    }

    @keyframes logo-pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    #game-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(4, 1fr);
      grid-gap: 10px;
      justify-content: center;
      margin: 20px auto;
      perspective: 1000px;
      position: relative;
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
      transition: opacity 0.5s;
      max-width: 100%;
      width: 300px;
    }

    .card {
      width: 80px;
      height: 120px;
      position: relative;
      cursor: pointer;
      transform-style: preserve-3d;
      transition: transform 0.4s ease-in-out;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background: linear-gradient(45deg, #ffffff, #f0f0f0);
      animation: reflect 3s infinite linear;
    }

    @keyframes reflect {
      0% { box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 0 0 20px rgba(255,255,255,0.3); }
      50% { box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 20px 0 20px rgba(255,255,255,0.5); }
      100% { box-shadow: 0 4px 8px rgba(0,0,0,0.2), inset 0 0 20px rgba(255,255,255,0.3); }
    }

    .card:hover {
      transform: scale(1.05) translateZ(10px);
    }

    .card.flipped {
      transform: rotateY(180deg);
    }

    .card .front, .card .back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .card .back {
      background: linear-gradient(45deg, #667eea, #764ba2);
      box-shadow: inset 0 0 10px rgba(255,255,255,0.3);
    }

    .card .front {
      background: #fffaf0;
      transform: rotateY(180deg);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }

    .card.matched .front {
      border: 3px solid #48bb78;
      animation: glow 0.8s infinite alternate;
    }

    .card.wrong {
      animation: shake 0.3s;
    }

    @keyframes glow {
      from { box-shadow: 0 0 10px #48bb78, 0 0 20px rgba(72,187,120,0.5); }
      to { box-shadow: 0 0 20px #48bb78, 0 0 40px rgba(72,187,120,0.8); }
    }

    @keyframes shake {
      0% { transform: rotateY(180deg) translateX(0); }
      25% { transform: rotateY(180deg) translateX(-5px); }
      50% { transform: rotateY(180deg) translateX(5px); }
      75% { transform: rotateY(180deg) translateX(-5px); }
      100% { transform: rotateY(180deg) translateX(0); }
    }

    #hearts {
      font-size: 24px;
      margin: 10px;
      transition: transform 0.3s;
    }

    #hearts.gain {
      transform: scale(1.3);
      color: #e53e3e;
    }

    #hearts.lose {
      animation: heart-bounce 0.5s;
    }

    @keyframes heart-bounce {
      0% { transform: scale(1); color: #e53e3e; }
      50% { transform: scale(0.7); color: #9b2c2c; }
      100% { transform: scale(1); color: #e53e3e; }
    }

    #message {
      font-size: 28px;
      font-weight: bold;
      margin: 10px;
      opacity: 0;
      transition: opacity 0.5s, transform 0.5s;
      z-index: 10;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    #message.show {
      opacity: 1;
      transform: scale(1.1);
    }

    #stage-indicator {
      font-size: 20px;
      margin: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
    }

    .stage-dot {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: #718096;
      transition: background 0.3s, color 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stage-dot.active {
      background: #48bb78;
      color: white;
    }

    .particle {
      position: absolute;
      border-radius: 50%;
      opacity: 0.9;
      pointer-events: none;
      animation: particle-burst 0.7s ease-out forwards;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    @keyframes particle-burst {
      0% { transform: scale(0) translate(0, 0); opacity: 1; }
      100% { transform: scale(1.5) translate(var(--dx), var(--dy)); opacity: 0; }
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--color);
      opacity: 0.8;
      pointer-events: none;
      animation: confetti-fall 2.5s ease-out forwards;
      box-shadow: 0 0 8px rgba(255,255,255,0.4);
    }

    @keyframes confetti-fall {
      0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    .victory-particle {
      position: absolute;
      border-radius: 50%;
      opacity: 0.9;
      pointer-events: none;
      animation: victory-burst 1.2s ease-out forwards;
      box-shadow: 0 0 15px rgba(255,255,255,0.7);
    }

    @keyframes victory-burst {
      0% { transform: scale(0) translate(0, 0); opacity: 1; }
      100% { transform: scale(2.5) translate(var(--dx), var(--dy)); opacity: 0; }
    }

    .bg-particle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      pointer-events: none;
      animation: bg-particle-float 5s infinite linear;
    }

    @keyframes bg-particle-float {
      0% { transform: translateY(100vh) scale(1); opacity: 0.3; }
      100% { transform: translateY(-100vh) scale(0.5); opacity: 0; }
    }

    .screen-shake {
      animation: screen-shake 0.5s;
    }

    @keyframes screen-shake {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-5px, 5px); }
      50% { transform: translate(5px, -5px); }
      75% { transform: translate(-3px, 3px); }
      100% { transform: translate(0, 0); }
    }

    #start-screen, #game-over-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      z-index: 20;
      transition: opacity 0.5s;
    }

    #start-screen.show, #game-over-screen.show {
      opacity: 1;
      display: flex;
    }

    #start-screen:not(.show), #game-over-screen:not(.show) {
      opacity: 0;
      display: none;
    }

    #start-screen h1 {
      animation: logo-bounce 1.5s infinite;
    }

    @keyframes logo-bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    #welcome-message {
      font-size: 1em;
      margin: 15px;
      opacity: 0;
      animation: fade-in 1s forwards 0.5s;
    }

    @keyframes fade-in {
      to { opacity: 1; }
    }

    button {
      padding: 10px 25px;
      font-size: 16px;
      font-family: 'Noto Sans KR', sans-serif;
      background: #48bb78;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: transform 0.2s, background 0.2s;
      position: relative;
      overflow: hidden;
      touch-action: manipulation;
    }

    button::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      transition: width 0.3s, height 0.3s;
    }

    button:hover {
      transform: scale(1.1);
      background: #38a169;
    }

    button:active::after {
      width: 150px;
      height: 150px;
    }

    #score, #timer {
      font-size: 18px;
      margin: 5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    #hint-button {
      position: fixed;
      top: 10px;
      right: 10px;
      margin: 0;
      padding: 8px 15px;
      font-size: 14px;
      z-index: 15;
    }

    #progress-bar {
      width: 250px;
      height: 8px;
      background: rgba(255,255,255,0.3);
      border-radius: 5px;
      margin: 10px auto;
      overflow: hidden;
    }

    #progress-fill {
      height: 100%;
      background: #48bb78;
      transition: width 0.3s;
    }

    @media (max-width: 600px) {
      body {
        padding-bottom: 80px;
      }
      #game-board {
        width: 240px;
        grid-gap: 6px;
        padding: 8px;
        border-radius: 10px;
      }
      #game-board.stage-5 {
        width: 300px;
      }
      .card {
        width: 64px;
        height: 96px;
        font-size: 20px;
      }
      .stage-5 .card {
        width: 60px;
        height: 90px;
        font-size: 18px;
      }
      .stage-5 .card .front, .stage-5 .card .back {
        font-size: 18px;
      }
      #progress-bar {
        width: 200px;
      }
      h1 {
        font-size: 1.8em;
      }
      button {
        padding: 8px 20px;
        font-size: 14px;
      }
      #message {
        font-size: 24px;
      }
      #score, #timer {
        font-size: 16px;
      }
      #stage-indicator {
        font-size: 18px;
      }
      .stage-dot {
        width: 20px;
        height: 20px;
        font-size: 12px;
      }
      #hint-button {
        top: 5px;
        right: 5px;
        padding: 6px 12px;
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="start-screen" class="show">
    <h1>메모리 카드 게임</h1>
    <p id="welcome-message">매칭 챌린지에 오신 것을 환영합니다!</p>
    <button id="start-button">게임 시작</button>
  </div>
  <div id="game-over-screen">
    <h1>게임 오버!</h1>
    <p id="final-score"></p>
    <p>다시 도전하여 최고 점수를 갱신하세요!</p>
    <button id="restart-button">다시 시작</button>
  </div>
  <h1>메모리 카드 게임</h1>
  <div id="score">점수: 0</div>
  <div id="timer">남은 시간: 60초</div>
  <div id="stage-indicator"></div>
  <div id="progress-bar"><div id="progress-fill" style="width: 0%;"></div></div>
  <div id="hearts"></div>
  <div id="game-board"></div>
  <div id="message"></div>
  <button id="hint-button">힌트 (하트 2개)</button>

  <script>
    const CONFIG = {
      MAX_STAGES: 5,
      HEARTS_PER_STAGE: [10, 8, 6, 6, 5],
      TIME_LIMITS: [60, 50, 40, 35, 30],
      CARD_PAIRS: [6, 6, 6, 8, 8],
      CARD_FLIP_DURATION: 400,
      WRONG_CARD_RESET_DELAY: 400,
      SHAKE_ANIMATION_DURATION: 300,
      GLOW_ANIMATION_DURATION: 800,
      MESSAGE_DISPLAY_DURATION: 1500,
      STAGE_TRANSITION_DELAY: 2500,
      HEART_GAIN_ANIMATION: 300,
      HEART_LOSE_ANIMATION: 500,
      PARTICLE_COUNT: 40,
      PARTICLE_DISTANCE: { MIN: 20, MAX: 120 },
      CONFETTI_COUNT: 80,
      VICTORY_PARTICLE_COUNT: 150,
      VICTORY_PARTICLE_DISTANCE: { MIN: 50, MAX: 250 },
      PARTICLE_COLORS: ['#ffcccb', '#b2fefa', '#b5f5ec', '#fefcbf', '#fed7aa', '#f5d0fe'],
      SCORE_PER_MATCH: 100,
      HINT_COST: 2,
      COMBO_MULTIPLIER: 1.5,
      COMBO_THRESHOLD: 2,
    };

    const STAGE_THEMES = [
      { bg: 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)', cardBack: 'linear-gradient(45deg, #667eea, #764ba2)' },
      { bg: 'linear-gradient(135deg, #b2fefa 0%, #81ecec 100%)', cardBack: 'linear-gradient(45deg, #00b894, #00cec9)' },
      { bg: 'linear-gradient(135deg, #fed7aa 0%, #fab1a0 100%)', cardBack: 'linear-gradient(45deg, #e17055, #fdcb6e)' },
      { bg: 'linear-gradient(135deg, #fd79a8 0%, #e84393 100%)', cardBack: 'linear-gradient(45deg, #d63031, #e84393)' },
      { bg: 'linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%)', cardBack: 'linear-gradient(45deg, #6c5ce7, #a29bfe)' },
    ];

    const audioFiles = {
      flip: 'https://freesound.org/data/previews/522/522444_7741464-lq.mp3',
      match: 'https://freesound.org/data/previews/171/171671_2437358-lq.mp3',
      mismatch: 'https://freesound.org/data/previews/415/415209_5121236-lq.mp3',
      stageClear: 'https://cdn.freesound.org/previews/171/171670_2437358-lq.mp3',
      gameOver: 'https://cdn.freesound.org/previews/171/171673_2437358-lq.mp3',
      victory: 'https://freesound.org/data/previews/154/154976_2731063-lq.mp3',
      hint: 'https://freesound.org/data/previews/522/522444_7741464-lq.mp3',
      bgm: 'https://cdn.pixabay.com/download/audio/2023/05/01/audio_32a3c268a7.mp3?filename=soft-ambient-piano-11894.mp3'
    };

    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const sounds = {};
    let isAudioUnlocked = false;

    async function unlockAudioContext() {
      if (audioContext.state === 'suspended') {
        try {
          await audioContext.resume();
          console.log('AudioContext resumed successfully');
          isAudioUnlocked = true;
        } catch (err) {
          console.warn('Failed to resume AudioContext:', err);
        }
      } else {
        isAudioUnlocked = true;
      }
    }

    function loadSound(key, url) {
      return new Promise((resolve, reject) => {
        const audio = new Audio(url);
        audio.preload = 'auto';
        audio.volume = key === 'bgm' ? 0.2 : 0.6;
        if (key === 'bgm') audio.loop = true;
        audio.addEventListener('canplaythrough', () => {
          console.log(`Sound ${key} loaded successfully`);
          resolve(audio);
        }, { once: true });
        audio.addEventListener('error', (e) => {
          console.warn(`Error loading sound ${key}:`, e);
          reject(e);
        }, { once: true });
        audio.load();
      });
    }

    async function initializeSounds() {
      for (const [key, url] of Object.entries(audioFiles)) {
        try {
          sounds[key] = await loadSound(key, url);
        } catch (err) {
          console.warn(`Failed to initialize sound ${key}:`, err);
        }
      }
    }

    async function playSound(key) {
      if (!sounds[key]) {
        console.warn(`Sound ${key} not found`);
        return;
      }
      if (!isAudioUnlocked) {
        await unlockAudioContext();
      }
      try {
        if (sounds[key].readyState < 2) {
          console.log(`Sound ${key} not ready, waiting...`);
          await new Promise((resolve) => {
            sounds[key].oncanplaythrough = () => resolve();
            sounds[key].onerror = () => resolve();
            setTimeout(resolve, 1500);
          });
        }
        sounds[key].currentTime = 0;
        const playPromise = sounds[key].play();
        if (playPromise !== undefined) {
          await playPromise;
          console.log(`Playing sound: ${key}`);
        }
      } catch (err) {
        console.warn(`Failed to play sound ${key}:`, err);
      }
    }

    const board = document.getElementById("game-board");
    const heartsDiv = document.getElementById("hearts");
    const messageDiv = document.getElementById("message");
    const stageIndicator = document.getElementById("stage-indicator");
    const scoreDiv = document.getElementById("score");
    const timerDiv = document.getElementById("timer");
    const startScreen = document.getElementById("start-screen");
    const gameOverScreen = document.getElementById("game-over-screen");
    const startButton = document.getElementById("start-button");
    const restartButton = document.getElementById("restart-button");
    const hintButton = document.getElementById("hint-button");
    const progressFill = document.getElementById("progress-fill");

    let stage = 1;
    let hearts = 0;
    let score = 0;
    let timeLeft = 0;
    let timerInterval = null;
    let firstCard = null;
    let lockBoard = false;
    let cards = [];
    let comboCount = 0;

    function createBackgroundParticles() {
      for (let i = 0; i < 20; i++) {
        const particle = document.createElement('div');
        particle.classList.add('bg-particle');
        particle.style.left = `${Math.random() * 100}vw`;
        particle.style.animationDelay = `${Math.random() * 5}s`;
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 5000);
      }
    }

    function startGame() {
      console.log("startGame function triggered");
      startScreen.classList.remove("show");
      startScreen.style.display = "none";
      board.style.opacity = "0";
      createBackgroundParticles();
      setInterval(createBackgroundParticles, 3000);
      startStage();
    }

    function endGame() {
      clearInterval(timerInterval);
      gameOverScreen.querySelector("#final-score").textContent = `최종 점수: ${score}`;
      gameOverScreen.classList.add("show");
      gameOverScreen.style.display = "flex";
      playSound('bgm').then(() => sounds.bgm.pause()).catch(() => console.warn("BGM pause failed"));
    }

function startStage() {
    console.log(`Starting stage ${stage}`);
    hearts = CONFIG.HEARTS_PER_STAGE[stage - 1];
    timeLeft = CONFIG.TIME_LIMITS[stage - 1];
    comboCount = 0;
    updateHearts();
    updateStageIndicator();
    updateTimer();
    updateProgress();
    scoreDiv.textContent = `점수: ${score}`;
    showMessage(`스테이지 ${stage}`);
    document.body.style.background = STAGE_THEMES[stage - 1].bg;
    document.querySelectorAll('.card .back').forEach(back => {
        back.style.background = STAGE_THEMES[stage - 1].cardBack;
    });
    board.style.opacity = "0";
    board.classList.remove('stage-5');
    if (stage === 4 || stage === 5) {
        board.classList.add('stage-5');
        board.style.gridTemplateColumns = 'repeat(4, 1fr)';
        board.style.gridTemplateRows = 'repeat(4, 1fr)';
    } else {
        board.style.gridTemplateColumns = 'repeat(3, 1fr)';
        board.style.gridTemplateRows = 'repeat(4, 1fr)';
    }
    setTimeout(() => {
        board.innerHTML = "";
        cards = generateCards();
        shuffle(cards);
        cards.forEach(img => {
            const card = document.createElement("div");
            card.classList.add("card");
            const front = document.createElement("div");
            front.classList.add("front");
            front.textContent = img;
            const back = document.createElement("div");
            back.classList.add("back");
            card.appendChild(front);
            card.appendChild(back);
            card.dataset.img = img;
            card.addEventListener("click", flipCard);
            card.addEventListener("touchstart", (e) => {
                e.preventDefault();
                flipCard.call(card);
            });
            board.appendChild(card);
        });
        board.style.opacity = "1";
        startTimer();
    }, 500);
    sounds.bgm.volume = 0.2 + (stage - 1) * 0.05;
}

    function updateHearts(change = 0) {
      hearts += change;
      heartsDiv.textContent = "❤️".repeat(hearts);
      if (change > 0) {
        heartsDiv.classList.add("gain");
        setTimeout(() => heartsDiv.classList.remove("gain"), CONFIG.HEART_GAIN_ANIMATION);
      } else if (change < 0) {
        heartsDiv.classList.add("lose");
        setTimeout(() => heartsDiv.classList.remove("lose"), CONFIG.HEART_LOSE_ANIMATION);
      }
    }

    function updateScore(points) {
      score += points;
      scoreDiv.textContent = `점수: ${score}`;
      if (points > 0) {
        scoreDiv.classList.add("gain");
        setTimeout(() => scoreDiv.classList.remove("gain"), CONFIG.HEART_GAIN_ANIMATION);
      }
    }

    function updateTimer() {
      timerDiv.textContent = `남은 시간: ${timeLeft}초`;
      if (timeLeft <= 10) {
        timerDiv.style.color = "#e53e3e";
      } else {
        timerDiv.style.color = "#2d3748";
      }
    }

    function updateProgress() {
      const matchedPairs = document.querySelectorAll(".matched").length / 2;
      const totalPairs = CONFIG.CARD_PAIRS[stage - 1];
      const progress = (matchedPairs / totalPairs) * 100;
      progressFill.style.width = `${progress}%`;
    }

    function startTimer() {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        updateTimer();
        if (timeLeft <= 0) {
          playSound('gameOver');
          showMessage("시간 초과!");
          endGame();
        }
      }, 1000);
    }

    function showMessage(text) {
      messageDiv.textContent = text;
      messageDiv.classList.add("show");
      setTimeout(() => {
        messageDiv.classList.remove("show");
      }, CONFIG.MESSAGE_DISPLAY_DURATION);
    }

    function updateStageIndicator() {
      stageIndicator.innerHTML = '';
      for (let i = 1; i <= CONFIG.MAX_STAGES; i++) {
        if (i > 1) {
          const connector = document.createTextNode('-');
          stageIndicator.appendChild(connector);
        }
        const dot = document.createElement('div');
        dot.classList.add('stage-dot');
        dot.textContent = i;
        if (i === stage) dot.classList.add('active');
        stageIndicator.appendChild(dot);
      }
    }

    function generateCards() {
      const base = ["🍎","🍌","🍇","🍓","🍊","🍉","🍍","🥝","🍒","🍑","🍋","🍈"];
      const pairCount = CONFIG.CARD_PAIRS[stage - 1];
      const selected = base.slice(0, pairCount);
      return [...selected, ...selected];
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function flipCard() {
      if (lockBoard || this.classList.contains("flipped")) return;
      this.classList.add("flipped");
      playSound('flip');
      if (!firstCard) {
        firstCard = this;
      } else {
        checkMatch(this);
      }
    }

    function useHint() {
      if (hearts < CONFIG.HINT_COST || lockBoard) return;
      playSound('hint');
      updateHearts(-CONFIG.HINT_COST);
      const unmatched = cards.filter((_, i) => !board.children[i].classList.contains("matched"));
      if (unmatched.length < 2) return;
      const pairValue = unmatched[0];
      const pairIndices = [];
      unmatched.forEach((value, i) => {
        if (value === pairValue) pairIndices.push(i);
      });
      if (pairIndices.length < 2) return;
      const [index1, index2] = pairIndices;
      const card1 = board.children[cards.indexOf(pairValue)];
      const card2 = board.children[cards.lastIndexOf(pairValue)];
      card1.classList.add("flipped");
      card2.classList.add("flipped");
      setTimeout(() => {
        card1.classList.remove("flipped");
        card2.classList.remove("flipped");
      }, CONFIG.MESSAGE_DISPLAY_DURATION);
    }

    function createMatchParticles(x, y) {
      for (let i = 0; i < CONFIG.PARTICLE_COUNT; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        const size = Math.random() * 10 + 5;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.background = CONFIG.PARTICLE_COLORS[Math.floor(Math.random() * CONFIG.PARTICLE_COLORS.length)];
        const angle = Math.random() * 2 * Math.PI;
        const distance = Math.random() * (CONFIG.PARTICLE_DISTANCE.MAX - CONFIG.PARTICLE_DISTANCE.MIN) + CONFIG.PARTICLE_DISTANCE.MIN;
        const dx = Math.cos(angle) * distance;
        const dy = Math.sin(angle) * distance;
        particle.style.setProperty('--dx', `${dx}px`);
        particle.style.setProperty('--dy', `${dy}px`);
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        board.appendChild(particle);
        setTimeout(() => particle.remove(), 700);
      }
    }

    function createConfetti() {
      for (let i = 0; i < CONFIG.CONFETTI_COUNT; i++) {
        const confetti = document.createElement('div');
        confetti.classList.add('confetti');
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = `${Math.random() * 10 + 5}px`;
        confetti.style.left = `${Math.random() * 100}vw`;
        confetti.style.background = CONFIG.PARTICLE_COLORS[Math.floor(Math.random() * CONFIG.PARTICLE_COLORS.length)];
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        document.body.appendChild(confetti);
        setTimeout(() => confetti.remove(), 2500);
      }
    }

    function createVictoryParticles() {
      document.body.classList.add('screen-shake');
      setTimeout(() => document.body.classList.remove('screen-shake'), 500);
      for (let i = 0; i < CONFIG.VICTORY_PARTICLE_COUNT; i++) {
        const particle = document.createElement('div');
        particle.classList.add('victory-particle');
        const size = Math.random() * 15 + 8;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.background = CONFIG.PARTICLE_COLORS[Math.floor(Math.random() * CONFIG.PARTICLE_COLORS.length)];
        const angle = Math.random() * 2 * Math.PI;
        const distance = Math.random() * (CONFIG.VICTORY_PARTICLE_DISTANCE.MAX - CONFIG.VICTORY_PARTICLE_DISTANCE.MIN) + CONFIG.VICTORY_PARTICLE_DISTANCE.MIN;
        const dx = Math.cos(angle) * distance;
        const dy = Math.sin(angle) * distance;
        particle.style.setProperty('--dx', `${dx}px`);
        particle.style.setProperty('--dy', `${dy}px`);
        particle.style.left = `${window.innerWidth / 2}px`;
        particle.style.top = `${window.innerHeight / 2}px`;
        document.body.appendChild(particle);
        setTimeout(() => particle.remove(), 1200);
      }
    }

    function checkMatch(secondCard) {
      lockBoard = true;
      if (firstCard.dataset.img === secondCard.dataset.img) {
        firstCard.classList.add("matched");
        secondCard.classList.add("matched");
        playSound('match');
        comboCount++;
        const points = comboCount >= CONFIG.COMBO_THRESHOLD ? Math.round(CONFIG.SCORE_PER_MATCH * CONFIG.COMBO_MULTIPLIER) : CONFIG.SCORE_PER_MATCH;
        updateHearts(+1);
        updateScore(points);
        const rect1 = firstCard.getBoundingClientRect();
        const rect2 = secondCard.getBoundingClientRect();
        const boardRect = board.getBoundingClientRect();
        const centerX = (rect1.left + rect2.left + rect1.width) / 2 - boardRect.left;
        const centerY = (rect1.top + rect2.top + rect1.height) / 2 - boardRect.top;
        createMatchParticles(centerX, centerY);
        updateProgress();
        firstCard = null;
        lockBoard = false;
      } else {
        playSound('mismatch');
        firstCard.classList.add("wrong");
        secondCard.classList.add("wrong");
        comboCount = 0;
        updateHearts(-1);
        setTimeout(() => {
          firstCard.classList.remove("flipped", "wrong");
          secondCard.classList.remove("flipped", "wrong");
          firstCard = null;
          lockBoard = false;
        }, CONFIG.WRONG_CARD_RESET_DELAY);
        if (hearts <= 0) {
          playSound('gameOver');
          showMessage("게임 오버!");
          endGame();
          return;
        }
      }
      if (document.querySelectorAll(".matched").length === cards.length) {
        clearInterval(timerInterval);
        playSound('stageClear');
        showMessage(`스테이지 ${stage} 클리어!`);
        createConfetti();
        if (stage === CONFIG.MAX_STAGES) {
          setTimeout(() => {
            showMessage("모든 스테이지 클리어! 승리!");
            playSound('victory');
            createVictoryParticles();
            endGame();
          }, CONFIG.STAGE_TRANSITION_DELAY);
        } else {
          stage += 1;
          setTimeout(() => startStage(), CONFIG.STAGE_TRANSITION_DELAY);
        }
      }
    }

    const styleSheet = document.styleSheets[0];
    styleSheet.insertRule(`.card { transition: transform ${CONFIG.CARD_FLIP_DURATION / 1000}s ease-in-out; }`, styleSheet.cssRules.length);
    styleSheet.insertRule(`.card.wrong { animation: shake ${CONFIG.SHAKE_ANIMATION_DURATION / 1000}s; }`, styleSheet.cssRules.length);
    styleSheet.insertRule(`.card.matched .front { animation: glow ${CONFIG.GLOW_ANIMATION_DURATION / 1000}s infinite alternate; }`, styleSheet.cssRules.length);

    document.addEventListener('DOMContentLoaded', () => {
      console.log("DOM fully loaded");
      initializeSounds().then(() => {
        console.log("All sounds initialized");
      }).catch(err => {
        console.warn("Sound initialization failed:", err);
      });
      startButton.removeEventListener('click', startGame);
      startButton.addEventListener('click', () => {
        console.log("Start button clicked");
        unlockAudioContext().then(() => {
          playSound('button').then(() => {
            console.log("Button sound played, starting game");
            startGame();
            playSound('bgm');
          }).catch(err => {
            console.warn("Button sound failed, starting game anyway:", err);
            startGame();
            playSound('bgm');
          });
        });
      });
      startButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        console.log("Start button touched");
        unlockAudioContext().then(() => {
          playSound('button').then(() => {
            console.log("Button sound played, starting game");
            startGame();
            playSound('bgm');
          }).catch(err => {
            console.warn("Button sound failed, starting game anyway:", err);
            startGame();
            playSound('bgm');
          });
        });
      });
      restartButton.removeEventListener('click', restartGame);
      restartButton.addEventListener('click', restartGame);
      restartButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        restartGame();
      });
      hintButton.removeEventListener('click', useHint);
      hintButton.addEventListener('click', () => {
        console.log("Hint button clicked");
        playSound('button');
        useHint();
      });
      hintButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        console.log("Hint button touched");
        playSound('button');
        useHint();
      });
    });

    function restartGame() {
      console.log("Restart button clicked");
      unlockAudioContext().then(() => {
        playSound('button').then(() => {
          gameOverScreen.classList.remove("show");
          gameOverScreen.style.display = "none";
          score = 0;
          stage = 1;
          playSound('bgm').then(() => sounds.bgm.currentTime = 0).catch(() => console.warn("BGM reset failed"));
          startStage();
        }).catch(err => {
          console.warn("Button sound failed:", err);
          gameOverScreen.classList.remove("show");
          gameOverScreen.style.display = "none";
          score = 0;
          stage = 1;
          startStage();
        });
      });
    }

    board.style.opacity = "0";
    console.log("Game initialized");
  </script>
</body>
</html>